local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local lp = Players.LocalPlayer
local playerGui = lp:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

local highlightEnabled = false
local nameEnabled = false
local studsEnabled = false
local minimized = false

local highlights = {}
local nameTags = {}

local function makeDraggable(frame)
	local dragging = false
	local dragInput
	local dragStart
	local startPos

	local function update(input)
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end

	frame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1
		or input.UserInputType == Enum.UserInputType.Touch then
			
			dragging = true
			dragStart = input.Position
			startPos = frame.Position
			
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	frame.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement
		or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			update(input)
		end
	end)
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_GUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 220, 0, 260)
mainFrame.Position = UDim2.new(0, 20, 0, 50)
mainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
makeDraggable(mainFrame)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,30)
title.BackgroundTransparency = 1
title.Text = "Yofalt ESP"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.Montserrat
title.TextSize = 18
title.Parent = mainFrame

local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0,25,0,25)
minimizeButton.Position = UDim2.new(1,-30,0,2)
minimizeButton.Text = "-"
minimizeButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
minimizeButton.TextColor3 = Color3.new(1,1,1)
minimizeButton.Font = Enum.Font.Montserrat
minimizeButton.TextSize = 16
minimizeButton.BorderSizePixel = 0
minimizeButton.Parent = mainFrame

local function createButton(text,posY)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,200,0,50)
	btn.Position = UDim2.new(0,10,0,posY)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(180,50,50)
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Font = Enum.Font.Montserrat
	btn.TextSize = 18
	btn.BorderSizePixel = 0
	btn.Parent = mainFrame
	return btn
end

local highlightButton = createButton("HITBOX OFF",40)
local nameButton = createButton("NAME OFF",100)
local studsButton = createButton("STUDS OFF",160)

minimizeButton.MouseButton1Click:Connect(function()
	minimized = not minimized
	
	if minimized then
		mainFrame.Size = UDim2.new(0,220,0,30)
		highlightButton.Visible = false
		nameButton.Visible = false
		studsButton.Visible = false
		minimizeButton.Text = "+"
	else
		mainFrame.Size = UDim2.new(0,220,0,260)
		highlightButton.Visible = true
		nameButton.Visible = true
		studsButton.Visible = true
		minimizeButton.Text = "-"
	end
end)

local function removeESP(plr)
	if highlights[plr] then
		highlights[plr]:Destroy()
		highlights[plr] = nil
	end
	if nameTags[plr] then
		nameTags[plr].gui:Destroy()
		nameTags[plr] = nil
	end
end

local function createESP(plr)
	if plr == lp then return end
	if not plr.Character then return end
	
	removeESP(plr)

	if highlightEnabled then
		local highlight = Instance.new("Highlight")
		highlight.FillTransparency = 1
		highlight.OutlineColor = Color3.new(1,1,1)
		highlight.OutlineTransparency = 0
		highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
		highlight.Adornee = plr.Character
		highlight.Parent = workspace
		highlights[plr] = highlight
	end
	
	local head = plr.Character:FindFirstChild("Head")
	local root = plr.Character:FindFirstChild("HumanoidRootPart")
	
	if head and root then
		local billboard = Instance.new("BillboardGui")
		billboard.Size = UDim2.new(0,100,0,25)
		billboard.StudsOffset = Vector3.new(0,2.5,0)
		billboard.AlwaysOnTop = true
		billboard.Parent = head
		
		local text = Instance.new("TextLabel")
		text.Size = UDim2.new(1,0,1,0)
		text.BackgroundTransparency = 1
		text.TextColor3 = Color3.new(1,1,1)
		text.TextStrokeTransparency = 0
		text.Font = Enum.Font.Montserrat
		text.TextScaled = true
		text.Parent = billboard
		
		nameTags[plr] = {
			gui = billboard,
			root = root,
			label = text,
			player = plr
		}
	end
end

RunService.RenderStepped:Connect(function()
	for plr,data in pairs(nameTags) do
		if data.root and data.root.Parent then
			
			local distance = (camera.CFrame.Position - data.root.Position).Magnitude
			
			local minSize = 60
			local maxSize = 130
			local maxDistance = 3000
			
			local clamped = math.clamp(distance,0,maxDistance)
			local alpha = clamped/maxDistance
			local finalSize = minSize + (alpha*(maxSize-minSize))
			
			data.gui.Size = UDim2.new(0,finalSize,0,finalSize*0.28)
			
			local textContent = ""
			
			if nameEnabled then
				textContent = data.player.Name
			end
			
			if studsEnabled then
				textContent = textContent.." ["..math.floor(distance).."]"
			end
			
			data.label.Text = textContent
		end
	end
end)

highlightButton.MouseButton1Click:Connect(function()
	highlightEnabled = not highlightEnabled
	
	if highlightEnabled then
		highlightButton.Text = "HITBOX ON"
		highlightButton.BackgroundColor3 = Color3.fromRGB(50,180,50)
	else
		highlightButton.Text = "HITBOX OFF"
		highlightButton.BackgroundColor3 = Color3.fromRGB(180,50,50)
	end
	
	for _,plr in ipairs(Players:GetPlayers()) do
		createESP(plr)
	end
end)

nameButton.MouseButton1Click:Connect(function()
	nameEnabled = not nameEnabled
	
	if nameEnabled then
		nameButton.Text = "NAME ON"
		nameButton.BackgroundColor3 = Color3.fromRGB(50,180,50)
	else
		nameButton.Text = "NAME OFF"
		nameButton.BackgroundColor3 = Color3.fromRGB(180,50,50)
	end
end)

studsButton.MouseButton1Click:Connect(function()
	studsEnabled = not studsEnabled
	
	if studsEnabled then
		studsButton.Text = "STUDS ON"
		studsButton.BackgroundColor3 = Color3.fromRGB(50,180,50)
	else
		studsButton.Text = "STUDS OFF"
		studsButton.BackgroundColor3 = Color3.fromRGB(180,50,50)
	end
end)

local function setupPlayer(plr)
	if plr == lp then return end
	
	local function onCharacter()
		task.wait(0.5)
		createESP(plr)
	end
	
	if plr.Character then
		onCharacter()
	end
	
	plr.CharacterAdded:Connect(onCharacter)
end

for _,plr in ipairs(Players:GetPlayers()) do
	setupPlayer(plr)
end

Players.PlayerAdded:Connect(setupPlayer)
Players.PlayerRemoving:Connect(removeESP)
